#!/usr/bin/env bash
set -euo pipefail

if [[ "$(id -u)" -ne 0 ]]; then
  echo "ERROR: Run as root (sudo -i)."
  exit 1
fi

BASE_DIR="${HOME:-/root}"

prompt() {
  local label="$1"
  local default="$2"
  local value=""
  read -r -p "${label} [${default}]: " value
  if [[ -z "$value" ]]; then
    value="$default"
  fi
  printf '%s' "$value"
}

prompt_secret() {
  local label="$1"
  local default="$2"
  local value=""
  read -r -s -p "${label} [${default}]: " value
  echo
  if [[ -z "$value" ]]; then
    value="$default"
  fi
  printf '%s' "$value"
}

resolve_path() {
  local input="$1"
  if [[ "$input" == "~" ]]; then
    printf '%s' "$BASE_DIR"
  elif [[ "$input" == "~/"* ]]; then
    printf '%s' "${BASE_DIR}/${input#~/}"
  elif [[ "$input" == /* ]]; then
    printf '%s' "$input"
  else
    printf '%s' "${BASE_DIR}/${input}"
  fi
}

run_as_user() {
  if [[ "$SERVICE_USER" == "root" ]]; then
    "$@"
  else
    runuser -u "$SERVICE_USER" -- "$@"
  fi
}

ensure_repo_access() {
  if [[ "$SERVICE_USER" == "root" ]]; then
    return
  fi
  if [[ "$REPO_DIR" == /root* ]]; then
    if command -v setfacl >/dev/null 2>&1; then
      setfacl -m "u:${SERVICE_USER}:rx" /root
      if [[ -d "$REPO_DIR" ]]; then
        setfacl -R -m "u:${SERVICE_USER}:rwX" "$REPO_DIR"
      fi
    else
      echo "ERROR: ${SERVICE_USER} cannot access /root without acl."
      echo "Install 'acl' or choose a repo path outside /root."
      exit 1
    fi
  fi
}

echo "PrintFleet2 setup for Debian 13 LXC."
echo "Relative paths resolve from ${BASE_DIR}."
echo "Press Enter to accept defaults."
echo

DEFAULT_REPO_DIR="${BASE_DIR}/printfleet2"
DEFAULT_SERVICE_USER="printfleet"
DEFAULT_ADMIN_USER="admin"
DEFAULT_ADMIN_PASS="admin"

REPO_DIR_INPUT="$(prompt "Installationspfad (Repo)" "$DEFAULT_REPO_DIR")"
SERVICE_USER="$(prompt "Service-Benutzer" "$DEFAULT_SERVICE_USER")"
ADMIN_USER="$(prompt "Admin-Benutzername" "$DEFAULT_ADMIN_USER")"
ADMIN_PASS="$(prompt_secret "Admin-Passwort" "$DEFAULT_ADMIN_PASS")"
VENV_DIR_INPUT="$(prompt "Python venv Pfad" "${REPO_DIR_INPUT}/.venv")"
START_TEST_RAW="$(prompt "Dev-Server nach dem Setup starten? (y/n)" "y")"

START_TEST="$(printf '%s' "$START_TEST_RAW" | tr '[:upper:]' '[:lower:]')"
REPO_DIR="$(resolve_path "$REPO_DIR_INPUT")"
VENV_DIR="$(resolve_path "$VENV_DIR_INPUT")"

echo
echo "Installing system packages..."
DEBIAN_FRONTEND=noninteractive apt-get update
DEBIAN_FRONTEND=noninteractive apt-get install -y sudo git python3 python3-venv python3-pip build-essential ffmpeg acl

if ! id -u "$SERVICE_USER" >/dev/null 2>&1; then
  useradd -m -s /bin/bash "$SERVICE_USER"
fi

ensure_repo_access

if [[ -d "$REPO_DIR" && -d "$REPO_DIR/src/printfleet2" ]]; then
  echo "Repo found in ${REPO_DIR}."
else
  if [[ -d "$REPO_DIR" && -n "$(ls -A "$REPO_DIR" 2>/dev/null)" ]]; then
    echo "ERROR: ${REPO_DIR} exists but does not look like PrintFleet2."
    exit 1
  fi
  REPO_URL="$(prompt "Git-Repository (URL)" "https://github.com/NeoFab/PrintFleet2.git")"
  mkdir -p "$REPO_DIR"
  chown -R "${SERVICE_USER}:${SERVICE_USER}" "$REPO_DIR"
  ensure_repo_access
  run_as_user git clone "$REPO_URL" "$REPO_DIR"
fi

if [[ ! -d "$REPO_DIR/src/printfleet2" ]]; then
  echo "ERROR: PrintFleet2 package not found in ${REPO_DIR}/src."
  exit 1
fi

REQ_FILE=""
if [[ -f "$REPO_DIR/requirements.txt" ]]; then
  REQ_FILE="$REPO_DIR/requirements.txt"
elif [[ -f "$REPO_DIR/src/requirements.txt" ]]; then
  REQ_FILE="$REPO_DIR/src/requirements.txt"
else
  echo "ERROR: requirements.txt not found."
  exit 1
fi

chown -R "${SERVICE_USER}:${SERVICE_USER}" "$REPO_DIR"
ensure_repo_access

if [[ ! -d "$VENV_DIR" ]]; then
  echo "Creating virtual environment..."
  run_as_user python3 -m venv "$VENV_DIR"
fi

echo "Installing Python dependencies..."
run_as_user "$VENV_DIR/bin/python" -m pip install --upgrade pip
run_as_user "$VENV_DIR/bin/python" -m pip install -r "$REQ_FILE"
run_as_user "$VENV_DIR/bin/python" -m pip install -e "$REPO_DIR"

echo "Running database migrations..."
run_as_user bash -lc "cd \"$REPO_DIR\" && \"$VENV_DIR/bin/alembic\" upgrade head"

echo "Creating admin user..."
run_as_user env ADMIN_USER="$ADMIN_USER" ADMIN_PASS="$ADMIN_PASS" "$VENV_DIR/bin/python" - <<'PY'
import os

from printfleet2.config import load_config
from printfleet2.db.session import init_engine, session_scope
from printfleet2.services.auth_service import hash_password
from printfleet2.services.user_service import create_user, get_user_by_username, has_users

cfg = load_config()
init_engine(cfg.database_url)

admin_user = (os.environ.get("ADMIN_USER") or "").strip()
admin_pass = (os.environ.get("ADMIN_PASS") or "").strip()

if not admin_user or not admin_pass:
    print("Skipping admin creation (missing username or password).")
else:
    with session_scope() as session:
        if get_user_by_username(session, admin_user):
            print(f"Admin user already exists: {admin_user}")
        else:
            role = "superadmin" if not has_users(session) else "admin"
            create_user(session, admin_user, hash_password(admin_pass), role=role)
            print(f"Admin user created: {admin_user} ({role})")
PY

echo
echo "Installation done."
echo "Test command:"
echo "  cd ${REPO_DIR} && ${VENV_DIR}/bin/python -m printfleet2"
echo "Open: http://<container-ip>:8080"
echo
echo "Next step:"
echo "  ${REPO_DIR}/setup/setupPrintFleet2Service"

if [[ "$START_TEST" == "y" ]]; then
  echo
  echo "Starting PrintFleet2 now. Stop with Ctrl+C when done testing."
  run_as_user bash -lc "cd \"$REPO_DIR\" && \"$VENV_DIR/bin/python\" -m printfleet2"
fi
