#!/usr/bin/env bash
set -euo pipefail

if [[ "$(id -u)" -ne 0 ]]; then
  echo "ERROR: Run as root (sudo -i)."
  exit 1
fi

BASE_DIR="${HOME:-/root}"

prompt() {
  local label="$1"
  local default="$2"
  local value=""
  read -r -p "${label} [${default}]: " value
  if [[ -z "$value" ]]; then
    value="$default"
  fi
  printf '%s' "$value"
}

resolve_path() {
  local input="$1"
  if [[ "$input" == "~" ]]; then
    printf '%s' "$BASE_DIR"
  elif [[ "$input" == "~/"* ]]; then
    printf '%s' "${BASE_DIR}/${input#~/}"
  elif [[ "$input" == /* ]]; then
    printf '%s' "$input"
  else
    printf '%s' "${BASE_DIR}/${input}"
  fi
}

ensure_repo_access() {
  if [[ "$SERVICE_USER" == "root" ]]; then
    return
  fi
  if [[ "$REPO_DIR" == /root* ]]; then
    if command -v setfacl >/dev/null 2>&1; then
      setfacl -m "u:${SERVICE_USER}:rx" /root
      if [[ -d "$REPO_DIR" ]]; then
        setfacl -R -m "u:${SERVICE_USER}:rwX" "$REPO_DIR"
      fi
    else
      echo "ERROR: ${SERVICE_USER} cannot access /root without acl."
      echo "Install 'acl' or choose a repo path outside /root."
      exit 1
    fi
  fi
}

echo "PrintFleet2 systemd service setup."
echo "Relative paths resolve from ${BASE_DIR}."
echo "Press Enter to accept defaults."
echo

DEFAULT_SERVICE_NAME="printfleet2"
DEFAULT_SERVICE_USER="printfleet"
DEFAULT_REPO_DIR="${BASE_DIR}/printfleet2"

SERVICE_NAME="$(prompt "Service-Name" "$DEFAULT_SERVICE_NAME")"
SERVICE_USER="$(prompt "Service-Benutzer" "$DEFAULT_SERVICE_USER")"
REPO_DIR_INPUT="$(prompt "Installationspfad (Repo)" "$DEFAULT_REPO_DIR")"
VENV_DIR_INPUT="$(prompt "Python venv Pfad" "${REPO_DIR_INPUT}/.venv")"

REPO_DIR="$(resolve_path "$REPO_DIR_INPUT")"
VENV_DIR="$(resolve_path "$VENV_DIR_INPUT")"

if [[ ! -d "$REPO_DIR" ]]; then
  echo "ERROR: Repo directory not found: $REPO_DIR"
  exit 1
fi

if [[ ! -d "$REPO_DIR/src/printfleet2" ]]; then
  echo "ERROR: PrintFleet2 package not found in ${REPO_DIR}/src."
  exit 1
fi

if [[ ! -x "$VENV_DIR/bin/python" ]]; then
  echo "ERROR: venv not found or invalid: $VENV_DIR"
  exit 1
fi

if ! id -u "$SERVICE_USER" >/dev/null 2>&1; then
  useradd -m -s /bin/bash "$SERVICE_USER"
fi

ensure_repo_access

service_file="/etc/systemd/system/${SERVICE_NAME}.service"

cat > "$service_file" <<EOF
[Unit]
Description=PrintFleet2 (${SERVICE_NAME})
After=network.target

[Service]
Type=simple
User=${SERVICE_USER}
WorkingDirectory=${REPO_DIR}/src
Environment=PYTHONUNBUFFERED=1
ExecStart=${VENV_DIR}/bin/python -m printfleet2
Restart=always
RestartSec=5

[Install]
WantedBy=multi-user.target
EOF

systemctl daemon-reload
systemctl enable --now "$SERVICE_NAME"

echo "Service installed and started: ${SERVICE_NAME}"
