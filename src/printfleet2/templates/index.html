{% extends "base.html" %}

{% block title %}PrintFleet2 | Dashboard{% endblock %}

{% block content %}
  <section class="hero">
    <div class="container hero-grid">
      <div class="hero-copy">
        <p class="eyebrow">PrintFleet2</p>
        <h1>Control your fleet.</h1>
        <p class="lead">Fast status, clear actions.</p>
        <div class="hero-actions">
          <a class="btn outline" href="/api/printers">Printers JSON</a>
        </div>
      </div>
      <div class="hero-card reveal" style="animation-delay: 0.1s">
        <h3>Live snapshot</h3>
        <div class="metric">
          <span class="metric-label">Printers</span>
          <span class="metric-value" id="printerCount">{{ snapshot.total_printers if snapshot else "--" }}</span>
        </div>
        <div class="metric">
          <span class="metric-label">Print jobs active</span>
          <span class="metric-value" id="activePrintsCount">{{ snapshot.active_prints if snapshot else "--" }}</span>
        </div>
        <div class="metric">
          <span class="metric-label">Print jobs today</span>
          <span class="metric-value" id="printJobsTodayCount">{{ snapshot.total_print_jobs_today if snapshot else "--" }}</span>
        </div>
        <div class="metric">
          <span class="metric-label">Print jobs total</span>
          <span class="metric-value" id="printJobsTotalCount">{{ snapshot.total_print_jobs_total if snapshot else "--" }}</span>
        </div>
        <div class="metric">
          <span class="metric-label">Errors</span>
          <span class="metric-value" id="activeErrorsCount">{{ snapshot.active_errors if snapshot else "--" }}</span>
        </div>
        <div class="metric">
          <span class="metric-label">Power (W)</span>
          <span class="metric-value" id="totalPowerNow">--</span>
        </div>
        <div class="metric">
          <span class="metric-label">Today (kWh)</span>
          <span class="metric-value" id="totalEnergyToday">--</span>
        </div>
        <div class="metric">
          <span class="metric-label">Print time today (h)</span>
          <span class="metric-value" id="totalPrintTimeToday">--</span>
        </div>
        <div class="metric">
          <span class="metric-label">Print time total (h)</span>
          <span class="metric-value" id="totalPrintTimeTotal">--</span>
        </div>
      </div>
    </div>
  </section>

  <section class="container grid">
    <article class="card reveal" style="animation-delay: 0.2s">
      <h3>System</h3>
      <p class="muted">Defaults from settings.</p>
      <ul class="spec">
        <li><span>Reload</span><strong id="settingsReload">--</strong></li>
        <li><span>Kiosk layout</span><strong id="settingsLayout">--</strong></li>
      </ul>
    </article>
    <article class="card reveal" style="animation-delay: 0.3s">
      <h3>Printers</h3>
      <p class="muted">Active printers only.</p>
      <ul class="list" id="printerList">
        {% if active_printer_names %}
          {% for name in active_printer_names %}
            <li>{{ name }}</li>
          {% endfor %}
        {% else %}
          <li class="muted">No active printers.</li>
        {% endif %}
      </ul>
    </article>
    <article class="card reveal" style="animation-delay: 0.4s">
      <h3>Quick actions</h3>
      <div class="actions">
        <a class="btn soft" href="/printer-dashboard">Printer dash</a>
        <a class="btn soft" href="/printer-just">Just Print</a>
        <a class="btn soft" href="/printer-group-just">Just Group Print</a>
      </div>
    </article>
  </section>
{% endblock %}

{% block scripts %}
  <script>
    let snapshotIntervalId = null;
    let snapshotIntervalMs = 5000;

    async function fetchJson(url, options = {}) {
      try {
        const res = await fetch(url, { credentials: "same-origin", ...options });
        if (!res.ok) {
          return null;
        }
        const text = await res.text();
        if (!text) {
          return null;
        }
        try {
          return JSON.parse(text);
        } catch (error) {
          return null;
        }
      } catch (error) {
        return null;
      }
    }

    async function loadSettings() {
      const data = await fetchJson("/api/settings");
      if (!data) return;
      document.getElementById("settingsReload").textContent = data.db_reload_interval ? data.db_reload_interval + "s" : "--";
      document.getElementById("settingsLayout").textContent = data.kiosk_stream_layout || "--";
      const pollSeconds = Number(data.poll_interval);
      if (Number.isFinite(pollSeconds) && pollSeconds > 0) {
        snapshotIntervalMs = Math.round(pollSeconds * 1000);
      }
    }

    function isPrintingStatus(status) {
      if (!status || typeof status.status !== "string") {
        return false;
      }
      return status.status.toLowerCase().includes("printing");
    }

    function hasErrorStatus(status) {
      if (!status) {
        return false;
      }
      if (status.status_state === "error") {
        return true;
      }
      if (typeof status.error_message === "string" && status.error_message.trim()) {
        return true;
      }
      return false;
    }

    function formatMetricValue(value, options = {}) {
      if (!Number.isFinite(value)) {
        return "--";
      }
      return value.toLocaleString("de-DE", options);
    }

    function sumPrintTime(printers, key) {
      if (!Array.isArray(printers)) {
        return NaN;
      }
      let total = 0;
      let count = 0;
      printers.forEach((printer) => {
        if (!printer) {
          return;
        }
        const value = Number(printer[key]);
        if (Number.isFinite(value)) {
          total += value;
          count += 1;
        }
      });
      return count ? total : NaN;
    }

    async function loadLiveSnapshot() {
      const [printersData, statusData, energyData] = await Promise.all([
        fetchJson("/api/printers"),
        fetchJson("/api/live-wall/status", { cache: "no-store" }),
        fetchJson("/api/printers/plug-energy", { cache: "no-store" }),
      ]);

      const printers = (printersData && printersData.items) || [];
      const activePrinters = printers.filter((printer) => printer.enabled);
      const statuses = (statusData && statusData.items) || [];
      const totalPrinters = statusData ? Number(statusData.total_printers) : NaN;
      const totalCount = Number.isFinite(totalPrinters) ? totalPrinters : printers.length || statuses.length;
      document.getElementById("printerCount").textContent = Number.isFinite(totalCount) ? totalCount : "--";

      const list = document.getElementById("printerList");
      list.innerHTML = "";
      const listItems = activePrinters.length ? activePrinters : statuses;
      if (!listItems.length) {
        list.innerHTML = "<li class=\"muted\">No active printers.</li>";
      } else {
        listItems.forEach((printer) => {
          const li = document.createElement("li");
          li.textContent = printer.name || "Unnamed printer";
          list.appendChild(li);
        });
      }

      if (statuses.length) {
        const activePrints = statuses.filter(isPrintingStatus).length;
        const activeErrors = statuses.filter(hasErrorStatus).length;
        document.getElementById("activePrintsCount").textContent = activePrints;
        document.getElementById("activeErrorsCount").textContent = activeErrors;
      }

      const jobsToday = statusData ? Number(statusData.total_print_jobs_today) : NaN;
      const jobsTotal = statusData ? Number(statusData.total_print_jobs_total) : NaN;
      const printJobsToday = document.getElementById("printJobsTodayCount");
      if (printJobsToday) {
        printJobsToday.textContent = Number.isFinite(jobsToday) ? jobsToday : "--";
      }
      const printJobsTotal = document.getElementById("printJobsTotalCount");
      if (printJobsTotal) {
        printJobsTotal.textContent = Number.isFinite(jobsTotal) ? jobsTotal : "--";
      }

      const energyItems = (energyData && Array.isArray(energyData.items)) ? energyData.items : [];
      let totalPower = 0;
      let powerCount = 0;
      let totalEnergyWh = 0;
      let energyCount = 0;
      energyItems.forEach((item) => {
        if (!item) {
          return;
        }
        const power = Number(item.power_w);
        if (Number.isFinite(power)) {
          totalPower += power;
          powerCount += 1;
        }
        const todayWh = Number(item.today_wh);
        if (Number.isFinite(todayWh)) {
          totalEnergyWh += todayWh;
          energyCount += 1;
        }
      });
      document.getElementById("totalPowerNow").textContent = powerCount
        ? formatMetricValue(totalPower, { maximumFractionDigits: 1 })
        : "--";
      document.getElementById("totalEnergyToday").textContent = energyCount
        ? formatMetricValue(totalEnergyWh / 1000, { maximumFractionDigits: 2 })
        : "--";

      const statusTodaySeconds = statusData ? Number(statusData.total_print_time_today_seconds) : NaN;
      const statusTotalSeconds = statusData ? Number(statusData.total_print_time_total_seconds) : NaN;
      const totalTodaySeconds = Number.isFinite(statusTodaySeconds)
        ? statusTodaySeconds
        : sumPrintTime(printers, "print_time_today_seconds");
      const totalAllSeconds = Number.isFinite(statusTotalSeconds)
        ? statusTotalSeconds
        : sumPrintTime(printers, "print_time_total_seconds");
      const totalPrintTimeToday = document.getElementById("totalPrintTimeToday");
      if (totalPrintTimeToday) {
        totalPrintTimeToday.textContent = Number.isFinite(totalTodaySeconds)
          ? formatMetricValue(totalTodaySeconds / 3600, { maximumFractionDigits: 1 })
          : "--";
      }
      const totalPrintTimeTotal = document.getElementById("totalPrintTimeTotal");
      if (totalPrintTimeTotal) {
        totalPrintTimeTotal.textContent = Number.isFinite(totalAllSeconds)
          ? formatMetricValue(totalAllSeconds / 3600, { maximumFractionDigits: 1 })
          : "--";
      }
    }

    function scheduleLiveSnapshot() {
      if (snapshotIntervalId) {
        clearInterval(snapshotIntervalId);
      }
      snapshotIntervalId = setInterval(loadLiveSnapshot, snapshotIntervalMs);
    }

    async function initDashboard() {
      await loadSettings();
      await loadLiveSnapshot();
      scheduleLiveSnapshot();
    }

    initDashboard();
  </script>
{% endblock %}
