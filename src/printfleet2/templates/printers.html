{% extends "base.html" %}

{% block title %}PrintFleet2 | Printers{% endblock %}

{% block content %}
  <section class="container docs">
    <div class="docs-hero">
      <p class="eyebrow">Printers</p>
      <h1>Manage your printer fleet</h1>
      <p class="lead">Create, update, or remove printers using the API-backed form.</p>
    </div>

    <div class="card">
      <h3>Printer form</h3>
      <p class="muted">Required: name, backend, host.</p>
      <div id="printerNotice" class="notice"></div>
      <form id="printerForm" class="form-grid">
        <input type="hidden" id="printerId">

        <label>
          Name
          <input type="text" id="printerName" required>
        </label>
        <label>
          Backend
          <select id="printerBackend" required>
            <option value="">Select backend</option>
            <option value="moonraker">Moonraker</option>
            <option value="octoprint">OctoPrint</option>
            <option value="centauri">Centauri</option>
          </select>
        </label>
        <label>
          Host
          <input type="text" id="printerHost" placeholder="192.168.1.10" required>
        </label>
        <label>
          Port
          <input type="number" id="printerPort" value="80" min="1" max="65535">
        </label>
        <label class="checkbox">
          <input type="checkbox" id="printerHttps">
          HTTPS
        </label>
        <label class="checkbox">
          <input type="checkbox" id="printerEnabled" checked>
          Enabled
        </label>
        <label class="checkbox">
          <input type="checkbox" id="printerNoScan">
          No scanning
        </label>

        <div class="form-actions">
          <button class="btn primary" type="submit" id="printerSubmit">Create printer</button>
          <button class="btn outline" type="button" id="printerReset">Clear</button>
        </div>
      </form>
    </div>

    <div class="card">
      <div class="table-header">
        <h3>Configured printers</h3>
        <button class="btn soft" id="printerRefresh">Refresh</button>
      </div>
      <div class="table-wrap">
        <table class="data-table">
          <thead>
            <tr>
              <th>Name</th>
              <th>Backend</th>
              <th>Host</th>
              <th>Port</th>
              <th>HTTPS</th>
              <th>Enabled</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="printerTable">
            <tr>
              <td colspan="7" class="muted">No printers loaded yet.</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </section>
{% endblock %}

{% block scripts %}
  <script>
    const form = document.getElementById("printerForm");
    const notice = document.getElementById("printerNotice");
    const submitBtn = document.getElementById("printerSubmit");
    const resetBtn = document.getElementById("printerReset");
    const refreshBtn = document.getElementById("printerRefresh");

    function setNotice(message, type) {
      notice.textContent = message;
      notice.className = "notice " + (type || "");
      if (!message) {
        notice.className = "notice";
      }
    }

    function formData() {
      return {
        name: document.getElementById("printerName").value.trim(),
        backend: document.getElementById("printerBackend").value,
        host: document.getElementById("printerHost").value.trim(),
        port: Number(document.getElementById("printerPort").value || 80),
        https: document.getElementById("printerHttps").checked,
        enabled: document.getElementById("printerEnabled").checked,
        no_scanning: document.getElementById("printerNoScan").checked
      };
    }

    function fillForm(printer) {
      document.getElementById("printerId").value = printer.id;
      document.getElementById("printerName").value = printer.name || "";
      document.getElementById("printerBackend").value = printer.backend || "";
      document.getElementById("printerHost").value = printer.host || "";
      document.getElementById("printerPort").value = printer.port || 80;
      document.getElementById("printerHttps").checked = !!printer.https;
      document.getElementById("printerEnabled").checked = !!printer.enabled;
      document.getElementById("printerNoScan").checked = !!printer.no_scanning;
      submitBtn.textContent = "Save changes";
    }

    function clearForm(options) {
      const keepNotice = options && options.keepNotice;
      document.getElementById("printerId").value = "";
      document.getElementById("printerName").value = "";
      document.getElementById("printerBackend").value = "";
      document.getElementById("printerHost").value = "";
      document.getElementById("printerPort").value = 80;
      document.getElementById("printerHttps").checked = false;
      document.getElementById("printerEnabled").checked = true;
      document.getElementById("printerNoScan").checked = false;
      submitBtn.textContent = "Create printer";
      if (!keepNotice) {
        setNotice("", "");
      }
    }

    async function loadPrinters() {
      const res = await fetch("/api/printers");
      const data = res.ok ? await res.json() : { items: [] };
      if (!res.ok) {
        setNotice("Failed to load printers.", "error");
      }
      const items = data.items || [];
      const table = document.getElementById("printerTable");
      table.innerHTML = "";
      if (!items.length) {
        table.innerHTML = "<tr><td colspan=\\"7\\" class=\\"muted\\">No printers loaded yet.</td></tr>";
        return;
      }
      items.forEach((printer) => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${printer.name}</td>
          <td>${printer.backend}</td>
          <td>${printer.host}</td>
          <td>${printer.port}</td>
          <td>${printer.https ? "Yes" : "No"}</td>
          <td>${printer.enabled ? "Yes" : "No"}</td>
          <td>
            <button class="btn small" data-action="edit">Edit</button>
            <button class="btn small danger" data-action="delete">Delete</button>
          </td>
        `;
        row.querySelector('[data-action="edit"]').addEventListener("click", () => fillForm(printer));
        row.querySelector('[data-action="delete"]').addEventListener("click", async () => {
          if (!confirm("Delete printer " + printer.name + "?")) return;
          const del = await fetch("/api/printers/" + printer.id, { method: "DELETE" });
          if (del.ok) {
            setNotice("Printer deleted.", "success");
            loadPrinters();
            clearForm({ keepNotice: true });
          } else {
            setNotice("Failed to delete printer.", "error");
          }
        });
        table.appendChild(row);
      });
    }

    form.addEventListener("submit", async (event) => {
      event.preventDefault();
      const payload = formData();
      if (!payload.name || !payload.backend || !payload.host) {
        setNotice("Name, backend, and host are required.", "error");
        return;
      }
      const printerId = document.getElementById("printerId").value;
      const method = printerId ? "PATCH" : "POST";
      const url = printerId ? "/api/printers/" + printerId : "/api/printers";
      const res = await fetch(url, {
        method,
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      if (res.ok) {
        setNotice(printerId ? "Printer updated." : "Printer created.", "success");
        clearForm({ keepNotice: true });
        await loadPrinters();
      } else {
        const data = await res.json().catch(() => ({}));
        setNotice(data.error || "Request failed.", "error");
      }
    });

    resetBtn.addEventListener("click", () => clearForm());
    refreshBtn.addEventListener("click", loadPrinters);

    loadPrinters();
  </script>
{% endblock %}
